/*
 * File: app/view/DetailContainer.js
 *
 * This file was generated by Sencha Architect
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.3.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.3.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Phonogram.view.DetailContainer', {
    extend: 'Ext.Container',

    requires: [
        'Ext.Toolbar',
        'Ext.Button',
        'Ext.Img'
    ],

    config: {
        id: 'DetailContainer',
        style: 'background-color:white;',
        layout: 'fit',
        items: [
            {
                xtype: 'toolbar',
                docked: 'top',
                id: 'detailBar',
                title: 'Record',
                items: [
                    {
                        xtype: 'button',
                        id: 'recordBackButton',
                        ui: 'back',
                        text: 'Back'
                    }
                ]
            },
            {
                xtype: 'container',
                id: 'detailContent',
                layout: 'vbox',
                scrollable: 'vertical',
                items: [
                    {
                        xtype: 'container',
                        centered: false,
                        height: 260,
                        id: 'detailImageContainer',
                        layout: 'vbox',
                        items: [
                            {
                                xtype: 'image',
                                flex: 1,
                                height: 240,
                                id: 'detailImage',
                                itemId: 'myimg1',
                                maxWidth: '100%',
                                style: '',
                                styleHtmlContent: true,
                                zIndex: 11,
                                backgroundCls: 'detailImageBackground'
                            }
                        ]
                    },
                    {
                        xtype: 'container',
                        id: 'textContainer',
                        style: 'background-color:white;',
                        zIndex: 100,
                        layout: 'vbox',
                        items: [
                            {
                                xtype: 'container',
                                id: 'recordButtonsContainer',
                                margin: '10 10 ',
                                items: [
                                    {
                                        xtype: 'button',
                                        border: '',
                                        id: 'addToCollectionButton',
                                        itemId: 'mybutton15',
                                        padding: '5 0 0 0 ',
                                        width: 146,
                                        text: 'Add to Collection'
                                    },
                                    {
                                        xtype: 'button',
                                        id: 'addToWantsButton',
                                        itemId: 'mybutton16',
                                        padding: '5 0 0 0 ',
                                        width: 146,
                                        text: 'Add to Wants'
                                    }
                                ]
                            },
                            {
                                xtype: 'container',
                                html: 'Album  Name',
                                id: 'detailAlbum',
                                margin: '10 10 0 10'
                            },
                            {
                                xtype: 'container',
                                html: 'Artist Name',
                                id: 'detailArtist',
                                margin: '0 10 ',
                                layout: 'vbox'
                            },
                            {
                                xtype: 'container',
                                html: 'Label Year US 123456',
                                id: 'detailRecord',
                                margin: '0 10 ',
                                layout: 'vbox'
                            },
                            {
                                xtype: 'container',
                                html: 'Friends who have this',
                                id: 'detailFriends',
                                margin: '0 10',
                                padding: '0 0 10 0'
                            },
                            {
                                xtype: 'container',
                                html: 'Track list',
                                id: 'detailTracks',
                                margin: '10 10'
                            }
                        ]
                    }
                ]
            }
        ],
        listeners: [
            {
                fn: 'onDetailImageError',
                event: 'error',
                delegate: '#detailImage'
            },
            {
                fn: 'onAddToCollectionButtonTap',
                event: 'tap',
                delegate: '#addToCollectionButton'
            },
            {
                fn: 'onAddToWantsButtonTap',
                event: 'tap',
                delegate: '#addToWantsButton'
            },
            {
                fn: 'onDetailContainerActivate',
                event: 'activate'
            },
            {
                fn: 'onDetailContainerRemove',
                event: 'remove'
            }
        ]
    },

    onDetailImageError: function(image, e, eOpts) {
        image.setSrc('https://s3.amazonaws.com/recccords/images/vinyl-placeholder-large.png');
    },

    onAddToCollectionButtonTap: function(button, e, eOpts) {
        console.log("DetailContainer: onAddToCollectionButtonTap");

        var successCB = function (results) {
            button.setDisabled(true);
            var style = {'background-color':'#D1D1D1','color':'#8A8A8A'};
            button.setStyle(style);
            Ext.Msg.alert("Added to Collection");
        };

        var failCB = function (error) {
            console.log('error ' + error);
            Ext.Msg.alert("Error adding to Collection");

        };

        saveToCollectionWithDiscogsData(this._data.discogsData,successCB,failCB);
    },

    onAddToWantsButtonTap: function(button, e, eOpts) {
        console.log("DetailContainer: onAddToWantsButtonTap");

        var successCB = function (results) {
            button.setDisabled(true);
            var style = {'background-color':'#D1D1D1','color':'#8A8A8A'};
            button.setStyle(style);
            Ext.Msg.alert("Added to Wants");
        };

        var failCB = function (error) {
            console.log('error ' + error);
            Ext.Msg.alert("Error adding to Wants");
        };

        saveToWantsWithDiscogsData(this._data.discogsData,successCB,failCB);
    },

    onDetailContainerActivate: function(newActiveItem, container, oldActiveItem, eOpts) {
        console.log('DetailContainer: activated');

        var me = this;

        // log the data
        // console.log(newActiveItem._data);

        // get discogs data

        var data = newActiveItem._data.discogsData;

        /*
            set the view for this vinyl
        */

        var detailImage = me.down("#detailContent").down("#detailImageContainer").down("#detailImage");
        detailImage.setSrc(data.images[0].uri150);

        var totalWidth = Ext.getBody().getWidth();
        var ratio = detailImage.getHeight()/detailImage.getWidth();
        var newHeight = ratio * totalWidth;
        detailImage.setHeight(newHeight);
        // console.log("newHeight " +newHeight + " detailimage height " + detailImage.getHeight());

        var detailTitle = me.down("#detailContent").down("#textContainer").down("#detailAlbum");
        detailTitle.setHtml(data.title);

        var detailArtist = me.down("#detailContent").down("#textContainer").down("#detailArtist");
        detailArtist.setHtml(data.artists[0].name);

        var detailRecord = me.down("#detailContent").down("#textContainer").down("#detailRecord");
        detailRecord.setHtml(data.labels[0].name + ' ' +  data.year + ' ' + data.country + ' ' + data.labels[0].catno);


        /*
            create the track list
        */

        var tracksHTML = "";
        for ( var ii = 0; ii < data.tracklist.length; ii++ ) {
          var thisTrack = data.tracklist[ii];
          tracksHTML += "<div><span class='detailTracks-position'>" + thisTrack.position + "</span><span class='detailTracks-title'>" + thisTrack.title + "</span><span class='detailTracks-duration'>" + thisTrack.duration + "</span></div>";
        }

        var detailTracks = me.down("#detailContent").down("#textContainer").down("#detailTracks");
        detailTracks.setHtml(tracksHTML);

        /*
            display 'friends' who have this
        */


        var friends = newActiveItem._data.friends;

        var detailFriends = me.down("#detailContent").down("#textContainer").down("#detailFriends");
        if ( friends.length === 0 ) {
            detailFriends.setHtml("None of your friend have this");
        } else {

            var friendsListHTML = "<div>Friends who have this </div>";
            for ( var ii in friends ) {
                friendsListHTML += "<div>" + friends[ii].attributes.username + "</div>";
            }

            detailFriends.setHtml(friendsListHTML);
        }

        /*
            display user status
        */

        var userStatus = newActiveItem._data.status;

        if ( userStatus.inCollection ) {
            var addToCollectionButton = me.down("#detailContent").down("#textContainer").down('#recordButtonsContainer').down("#addToCollectionButton");

            addToCollectionButton.setDisabled(true);

            var style = {'background-color':'#D1D1D1','color':'#8A8A8A'};
            addToCollectionButton.setStyle(style);

        }

        if ( userStatus.inWants ) {
            var addToWantsButton = me.down("#detailContent").down("#textContainer").down('#recordButtonsContainer').down("#addToWantsButton");

            addToWantsButton.setDisabled(true);

            var style = {'background-color':'#D1D1D1','color':'#8A8A8A'};
            addToWantsButton.setStyle(style);

        }

        /*
            handle images
        */

        var imageURL = newActiveItem._data.image;

        // be safe
        clearInterval(me.imagePolling);

        me.imagePolling = setInterval(function(){

            // imageURL needs to be an array
            getLocalImages([imageURL],function(res){

                if ( res.status == 200 || res.status == 204 ) {

                    // got the results, clear it now
                    clearInterval(me.imagePolling);

                    if ( res.results ) {

                        // setting the image
                        detailImage.setSrc(res.results[0]);

                    }
                }


            });

        },2500);


    },

    onDetailContainerRemove: function(container, item, index, eOpts) {
        if ( this.imagePolling ) {
            clearInterval(this.imagePolling);
        }
    }

});